<!DOCTYPE html>
<html lang="zh-TW">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  <link rel="icon" href="/images/site_logo.webp">
  <title>Treeboのブログ</title>
  <meta name="author" content="Treebo" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="技術部落格" />
  
  <meta property="og:type" content="website">
<meta property="og:title" content="Treeboのブログ">
<meta property="og:url" content="http://example.com/tags/%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97/page/2/index.html">
<meta property="og:site_name" content="Treeboのブログ">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="http://example.com/images/site_logo.webp">
<meta property="article:author" content="Treebo">
<meta property="article:tag" content="技術部落格">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/site_logo.webp">
<meta name="twitter:site" content="@null">
  
  <!-- 站点验证相关 -->
  
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" type="text/css" media="all">
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" type="text/css" media="all">
  
  
  <link rel="stylesheet" id="fontawe-css" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" type="text/css" media="all">
  <link rel="stylesheet" id="nprogress-css" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" type="text/css" media="all">
  
  
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-dark.min.css" type="text/css" media="all">
  
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['G-34GCMGPCS5']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXX-Y', 'auto');
    ga('send', 'pageview');
  </script>
  <!-- End Google Analytics -->
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="https://cdn.jsdelivr.net/npm/qrcode_js@1.0.0/qrcode.min.js"></script>
  
  
  <style>
    
      .kratos-cover.kratos-cover-2 {
        background-image: url('/images/banner.webp');
      }
    
    
      @media(min-width:768px) {
        body.custom-background {
          background-image: url('/images/bg.webp');
        }
      }
    
  </style>
  
<meta name="generator" content="Hexo 5.4.0"></head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                        <li><a href="/"><i class="fa fa-home"></i>首頁</a></li>
                                    
                                
                                    
                                        <li><a href="/archives/"><i class="fa fa-file"></i>歸檔</a></li>
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">Treeboのブログ</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>Treeboのブログ</h2> <br />
                        <span>學習與反思；交流與批判</span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

            <section class="col-md-8">

        

            
    
    
        <article>
            <div class="kratos-hentry kratos-post-inner clearfix index-post">
                <div class="kratos-entry-thumb-new">
                    <a href="/2021/05/22/%E4%BB%8A%E6%99%9A%EF%BC%8C%E6%88%91%E6%83%B3%E4%BE%86%E9%BB%9E%20Web%20%E5%89%8D%E7%AB%AF%E6%95%88%E8%83%BD%E5%84%AA%E5%8C%96%E5%A4%A7%E8%A3%9C%E5%B8%96/">
                        
                    </a>
                </div>
                <header class="kratos-entry-header">
                    <h1 class="text-center"><a class="kratos-entry-title" href="/2021/05/22/%E4%BB%8A%E6%99%9A%EF%BC%8C%E6%88%91%E6%83%B3%E4%BE%86%E9%BB%9E%20Web%20%E5%89%8D%E7%AB%AF%E6%95%88%E8%83%BD%E5%84%AA%E5%8C%96%E5%A4%A7%E8%A3%9C%E5%B8%96/">今晚，我想來點 Web 前端效能優化大補帖</a></h1>
                    
                    <ul class="kratos-post-meta text-center">
                        <li>
                            <i class="fa fa-calendar"></i>
                            2021-05-22
                        </li>
                        
                        
                            <li>
                                <i class="fa fa-tags"></i>
                                <a class="tag-none-link" href="/tags/front-end/" rel="tag">front-end</a>, <a class="tag-none-link" href="/tags/%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97/" rel="tag">閱讀心得</a>
                            </li>
                        
                        
                            <!-- 当前仅支持valine/waline自带的统计功能 -->
                            
                        
                        
                            <!-- 当前仅支持waline自带的统计功能 -->
                            
                        
                    </ul>
                </header>
                <hr />
                <div class="kratos-post-content">
                    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>效能是工程師在維護專案時非常重視的要點，不論是 Web 還是 App，甚至是需要大量運算資源的機器學習，都會想追求極致的效能，用高效率換取高價值。</p>
<p>不過，並不是所有的應用都需要追求效能，有時候獲取效能的背後也許需要花上昂貴的成本，比較起來是得不償失的，因此在進行效能調校前應該先好好衡量進行優化的成本（時間、困難度都需要考慮），有時候先求有再求好反而是較佳的方案。</p>
<p>另外一件事就是效能優化沒有所謂的終點，這是一段追求「快還要更快」的過程。</p>
<h2 id="Performance-Analyzers"><a href="#Performance-Analyzers" class="headerlink" title="Performance Analyzers"></a>Performance Analyzers</h2><p>在進行效能優化以前，我們得先找出效能瓶頸出自哪裡，這時候我們可以使用一些 performance analyzer 來幫助我們找到問題，其中較有名的是 Lighthouse 與 PageSpeed。</p>
<h2 id="Core-Web-Vital"><a href="#Core-Web-Vital" class="headerlink" title="Core Web Vital"></a>Core Web Vital</h2><p>Google 根據長期以來大量的使用者體驗制定出了 Core Web Vital 的指標，Google 更指出若 75% 以上的使用者在網站中的瀏覽體驗都能夠通過以上 3 種指標，就能夠大幅的提升使用者的搜尋體驗，甚至能夠讓原本因等待而離開的使用者減少 24%！</p>
<h2 id="LCP-Largest-Contentful-Paint-—-顯示最大內容元素所需時間-速度"><a href="#LCP-Largest-Contentful-Paint-—-顯示最大內容元素所需時間-速度" class="headerlink" title="LCP (Largest Contentful Paint ) — 顯示最大內容元素所需時間 (速度)"></a>LCP (Largest Contentful Paint ) — 顯示最大內容元素所需時間 (速度)</h2><p>LCP 是計算網頁可視區 (viewport) 中最大元件的載入時間，也就是頁面的主要內容被使用者看到的時間，是速度的指標。</p>
<p>不過可視區內最大的元素並不是固定不變的</p>
<p><img src="https://i.imgur.com/qiCyFWo.png"></p>
<p>上圖的頁面在載入時一開始可視區的最大元素是左上角的文字，接下來隨著頁面載入變成了標題，最後變成了圖片，因為圖片是可視區最大的元素了，因此 LCP 就會以該圖片所需要載入的時間做計算。</p>
<h3 id="如何優化-LCP"><a href="#如何優化-LCP" class="headerlink" title="如何優化 LCP"></a>如何優化 LCP</h3><h4 id="減少伺服器回應時間"><a href="#減少伺服器回應時間" class="headerlink" title="減少伺服器回應時間"></a>減少伺服器回應時間</h4><ul>
<li>針對主機效能優化</li>
<li>使用較近的 CDN</li>
<li>Cache</li>
<li>提早載入第三方資源</li>
</ul>
<h4 id="盡量避免-Blocking-Time"><a href="#盡量避免-Blocking-Time" class="headerlink" title="盡量避免 Blocking Time"></a>盡量避免 Blocking Time</h4><ul>
<li>降低 JavaScript blocking time</li>
<li>降低 CSS blocking time</li>
</ul>
<h4 id="避免使用客戶端渲染-CSR"><a href="#避免使用客戶端渲染-CSR" class="headerlink" title="避免使用客戶端渲染(CSR)"></a>避免使用客戶端渲染(CSR)</h4><ul>
<li>若必須使用 CSR ，建議優化 JavaScript ，避免渲染時使用太多資源</li>
<li>盡量在伺服器端完成頁面渲染，讓用戶端取得已渲染好的內容</li>
</ul>
<h2 id="FID-—-First-Input-Delay-首次輸入延遲-封鎖時間總計-互動性"><a href="#FID-—-First-Input-Delay-首次輸入延遲-封鎖時間總計-互動性" class="headerlink" title="FID — First Input Delay 首次輸入延遲/封鎖時間總計 (互動性)"></a>FID — First Input Delay 首次輸入延遲/封鎖時間總計 (互動性)</h2><p>輸入延遲 (Input Delay) 通常發生於瀏覽器的主執行序過度繁忙，而導致頁面內容無法正確地與使用者進行互動。舉例來說，可能瀏覽器正在載入一支相當肥大的 JavaScript 檔案，導致其他元素不能被載入而延遲可互動的時間。</p>
<h3 id="如何優化-FID"><a href="#如何優化-FID" class="headerlink" title="如何優化 FID"></a>如何優化 FID</h3><ul>
<li>減少 JavaScript 運作的時間</li>
<li>降低網站的 request 數並降低檔案大小</li>
<li>減少主執行序的工作</li>
<li>降低第三方程式碼的影響</li>
</ul>
<h2 id="CLS-—-Cumulative-Layout-Shift-累計版面配置轉移-穩定性"><a href="#CLS-—-Cumulative-Layout-Shift-累計版面配置轉移-穩定性" class="headerlink" title="CLS — Cumulative Layout Shift 累計版面配置轉移 (穩定性)"></a>CLS — Cumulative Layout Shift 累計版面配置轉移 (穩定性)</h2><p>有沒有遇過一種情況是當你在網頁中準備點擊一個按鈕或連結的瞬間，突然一個廣告被插入，讓你不小心點開別的網站，恨的牙癢癢的呢？這就是 CLS 這個指標想要避免的使用者體驗，如果不清楚以上情境的可以參考<a target="_blank" rel="noopener" href="https://web.dev/cls/">這篇</a></p>
<h3 id="如何避免-CLS"><a href="#如何避免-CLS" class="headerlink" title="如何避免 CLS"></a>如何避免 CLS</h3><ul>
<li>給予會比較慢載入的元素一個預設的寬度與高度</li>
</ul>
<h2 id="Code-Minimize-amp-Uglify"><a href="#Code-Minimize-amp-Uglify" class="headerlink" title="Code Minimize &amp; Uglify"></a>Code Minimize &amp; Uglify</h2><p>有時候你會想看看一些網頁的原始碼是怎麼運作的，不過當點選「檢查網頁原始碼」後，顯示出來的 code 有時卻讓你不知道這到底是哪個星球的程式語言。</p>
<p>不過其實這些看起來混亂的代碼其實就是我們寫出來的程式，雖然變數名稱跟邏輯似乎都跟我們原本開發時寫的不一樣，但它其實只是經過轉譯罷了。而這麼做主要的原因有兩個：</p>
<ul>
<li>變數跟 code 寫的越短，或是刪除不必要的空白，可以省掉不少瀏覽器 Parse 的時間，也就是提升前端程式的效能 — <strong>Minimize</strong></li>
<li>通常會打亂程式的邏輯，避免自家產品的 code 輕鬆的被別人拿去研究或抄襲 — <strong>Uglify</strong></li>
</ul>
<p>如果要試試看效果，可以參考如 <code>JavaScript Minifier</code> 或 <code>Uglify JS</code> 等網頁服務，但通常在開發時我們不會笨拙的手動貼 code 去 Minimize 或 Uglify，而是會利用如 <code>webpack</code> 、<code>gulp</code> 等打包工具替我們做這些事情。</p>
<h2 id="Image-Minimize-amp-理解-jpg、png、-svg-的使用時機"><a href="#Image-Minimize-amp-理解-jpg、png、-svg-的使用時機" class="headerlink" title="Image Minimize &amp; 理解 jpg、png、 svg 的使用時機"></a>Image Minimize &amp; 理解 jpg、png、 svg 的使用時機</h2><p>現今的網站免不了會需要載入大量的圖片，圖片也因此成為網站載入資源的很大一部分，換句話說就是對網站效能有著直接的影響。在考慮 Image Lazy Load 等技巧以前，我們可以先將圖片壓縮，透過減少檔案大小來加快載入時間，而壓縮又分為兩種狀況：</p>
<ul>
<li>有損壓縮：如 JPG，使用只取部分像素資料的方式來壓縮圖片大小，並且壓縮後是不可逆的。</li>
<li>無損壓縮：如 PNG，壓縮後不影響圖片品質。</li>
</ul>
<p>三種圖片類型各自比較有名的圖片壓縮服務有 <a target="_blank" rel="noopener" href="https://tinypng.com/">tiny-png</a>、<a target="_blank" rel="noopener" href="https://jakearchibald.github.io/svgomg/">svgomg</a>、<a target="_blank" rel="noopener" href="http://jpeg-optimizer.com/">jpeg-optimizer</a>。</p>
<p>而其實不同的圖片類型也有各自適合使用的時機，學會將不同類型圖片應用在適合的地方不僅可以提升使用者體驗或 UI 品質，某些狀況下也可以控制載入資源的大小而提升一點效能。這裡推薦一篇<a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10252501">文章</a>，說明得十分完整，除了有介紹各種圖片類型的適當使用時機外，也有介紹如響應式圖片、webp、Image CDN 等其他圖片優化技巧，非常推薦一讀。</p>
<h2 id="Critical-Render-Path-關鍵渲染路徑"><a href="#Critical-Render-Path-關鍵渲染路徑" class="headerlink" title="Critical Render Path 關鍵渲染路徑"></a>Critical Render Path 關鍵渲染路徑</h2><p>提到網頁前端的效能最佳化，我們得先了解網頁是如何渲染到頁面上的，從收到 HTML、CSS 和 JavaScript，再對程式碼進行必需的處理，到最後轉變為顯示像素的過程中還有許多中間步驟。將效能最佳化其實就是瞭解這些步驟中所有的活動，再經過最佳化，這就是所謂的「關鍵渲染路徑（Critical Render Path）」。</p>
<p><img src="https://i.imgur.com/FKAMlEJ.png"></p>
<p>根據上圖，我們可以大致理解出網頁渲染的流程為：</p>
<ul>
<li>讀取 HTML 後生成 DOM Tree</li>
<li>讀取 HTML 中的 CSS Link Tag 生成 CSSOM Tree</li>
<li>DOM Tree 與 CSSOM Tree 共同生成 Render Tree</li>
<li>根據 Render Tree 生成 Layout</li>
<li>最後 Paint 畫面</li>
</ul>
<p>當然，現今的 web app 不太可能只靠 HTML 跟 CSS 就完成，還是得靠 JavaScript 來修改網頁的內容、樣式、與使用者互動的行為。JavaScript 可以查詢及修改 DOM 和 CSSOM，在 CSSOM 執行完畢後，JavaScript 才會執行 。這邊給一個小 tip：如果可以的話，CSS file 盡快引入，JS 在 CSS 後引入，因為 JS的執行會導致網頁載入的暫停（不過有例外的非同步功能）。</p>
<p>一般我們要載入 JavaScript 檔案，通常會透過 <code>&lt;script&gt;</code> 這個 Tag 來達成，不過它的執行是同步的，也就是會導致網頁載入的暫停，如下圖：</p>
<p><img src="https://i.imgur.com/wH6aGwa.png"></p>
<p>但其實 script tag 的引入還有 async 跟 defer 這兩種方式：</p>
<ul>
<li><strong>async</strong> 會非同步去請求外部腳本，回應後停止解析執行腳本內容。</li>
<li><strong>defer</strong> 也會非同步請求外部腳本，但是等待瀏覽器解析完才執行。</li>
</ul>
<p><code>&lt;script async&gt;</code> 用於載入第三方函式庫等不需要動到 DOM 結構的狀況</p>
<p><img src="https://i.imgur.com/IxpV2sn.png"></p>
<p><code>&lt;script defer &gt;</code> 要整個頁面都下載及分析完成後才會執行，非常類似於把 JS 放在頁尾的情況</p>
<p><img src="https://i.imgur.com/6eL9xJC.png"></p>
<h2 id="Code-Splitting"><a href="#Code-Splitting" class="headerlink" title="Code Splitting"></a>Code Splitting</h2><p>Code Splitting 是一個非常重要的觀念，現代網頁程式漸漸走向使用框架以模組化方式來開發，即便會透過如 webpack 等 bundler 來 uglify、minimize、打包程式碼，當專案成長到一定程度時，程式 bundle size 仍然會變得過於肥大，導致 client side 的網頁載入時間變長，嚴重影響使用者體驗。Code Splitting 就是為了要解決單一 JS Bundle 過於肥大的問題，將原本單一的 bundle 切分成數個小 chunk，可以搭配平行載入，或者是有需要時才載入某些特定的 chink，又或是對一些不常變動的 chunk 個別做快取，來達到載入效能的優化。</p>
<p>較常見的 Code Splitting 又分為兩種方式 :</p>
<ul>
<li>抽離第三方套件</li>
<li>動態載入功能模組 Dynamic Import</li>
</ul>
<h3 id="抽離第三方套件"><a href="#抽離第三方套件" class="headerlink" title="抽離第三方套件"></a>抽離第三方套件</h3><p>抽離第三方套件又可以細分兩種方式：</p>
<ul>
<li>將所有第三方套件打包為單一檔案</li>
<li>將第三方套件打包為多個檔案</li>
</ul>
<h4 id="將所有第三方套件打包為單一檔案"><a href="#將所有第三方套件打包為單一檔案" class="headerlink" title="將所有第三方套件打包為單一檔案"></a>將所有第三方套件打包為單一檔案</h4><p>關於 webpack 的 bundle，可以先做一個最大的拆分：</p>
<ul>
<li>Application Bundle ：UI 與商業邏輯，跟我們寫的程式有關，是經常變動的部分。</li>
<li>Vendor Bundle ：第三⽅套件 / node_modules，不太會變動。</li>
</ul>
<p>拆分出 Vendor Bundle 是有好處的，主要是因為通常它變動的頻率相對較低，因此比較適合被 cache，而在 Vendor Bundle 被 cache 的狀況下由於減少了 Application Bundle 的⼤⼩，因此加快了再訪者的載入速度。採用這樣的方式的優點為邏輯簡單，缺點為更新任何第三方套件都會使快取失效。</p>
<h4 id="將第三方套件打包為多個檔案"><a href="#將第三方套件打包為多個檔案" class="headerlink" title="將第三方套件打包為多個檔案"></a>將第三方套件打包為多個檔案</h4><p>採用這種方式的優點是可以根據套件關聯性打包，減少套件更新時造成的延遲。缺點則是相較前面打包成單一檔案的方式，這種方式需要處理的邏輯複雜許多。</p>
<h3 id="動態載入功能模組-Dynamic-Import"><a href="#動態載入功能模組-Dynamic-Import" class="headerlink" title="動態載入功能模組 Dynamic Import"></a>動態載入功能模組 Dynamic Import</h3><p>大多數狀態下我們會在檔案的開頭引入需要用到的模組，這些模組通常在網頁載入時就被引入進來，這種方式被稱為 static import，然而當有以下兩種狀況的需求時，static import 卻不能滿足我們：</p>
<ul>
<li>模組名稱為動態變數時</li>
<li>需依照特定邏輯或特定時機引入時</li>
</ul>
<p>這時候可以運用與之相對的技術： Dynamic Import。所謂 Dynamic Import 代表的即是</p>
<blockquote>
<h2 id="需要用到某段程式碼時才透過網路載入-JS-bundle"><a href="#需要用到某段程式碼時才透過網路載入-JS-bundle" class="headerlink" title="需要用到某段程式碼時才透過網路載入 JS bundle"></a>需要用到某段程式碼時才透過網路載入 JS bundle</h2></blockquote>
<h2 id="Webpack-Bundle-Analyzer"><a href="#Webpack-Bundle-Analyzer" class="headerlink" title="Webpack Bundle Analyzer"></a>Webpack Bundle Analyzer</h2><p><img src="https://i.imgur.com/QwSVSXG.png"></p>
<p>透過 webpack-bundle-analyzer，我們可以透過視覺化分析專案有哪些 bundle chunk，各個 bundle chunk 的組成又為何，再針對可以改進的 bundle 進行優化。</p>
<p>（類似功能的工具還有如 <strong>WebpackVisualizerPlugin</strong>）</p>
<h2 id="Lazy-Load-Image"><a href="#Lazy-Load-Image" class="headerlink" title="Lazy Load Image"></a>Lazy Load Image</h2><p>稍早的 Image Minimize 段落中有提到圖片佔了網站資源相當大的比例，因此如果在網頁載入的瞬間就想把所有圖片都載入下來對效能是一個硬傷，這時候可以採用 lazy load 的方法去載入圖片，一開始只需載入部分的圖片，待現有圖片快要接觸到 viewport 的底部時再去動態載入新的圖片，例如 imgur 這種圖床網站就勢必會做圖片的 lazy load。</p>
<p>要實現 image 的 lazy load 主要有兩種方式：</p>
<ul>
<li>搭配 Intersection Observer web API : 偵測目標元素是不是與特定位置交會，交會時再去載入新的資源。(可以參考我很久以前寫的練習作業)</li>
<li>瀏覽器原生支援 (<a target="_blank" rel="noopener" href="https://web.dev/browser-level-image-lazy-loading/">參考連結</a>)</li>
</ul>
<h2 id="Virtualized-List"><a href="#Virtualized-List" class="headerlink" title="Virtualized List"></a>Virtualized List</h2><p>長列表（例如大量的文章列表）是網站中蠻常見的一個 feature，然而如果有 1000 篇文章，我們又將這些文章同時渲染的話，就必須生成 1000 個 dom 節點，更不用說文章結構通常是相對複雜的，像這樣同時渲染數量頗大的元素會有幾個明顯的缺點：</p>
<ul>
<li>載入時白屏時間會比較長</li>
<li>渲染了大量的 dom 節點的狀況下，在滾動事件觸發時會大大增加記憶體的用量</li>
<li>容易失幀，因為渲染很慢，所以無法維持瀏覽器的幀率，頁面會顯得卡頓</li>
<li>最慘的話網頁會失去響應</li>
</ul>
<p>而且這些問題在 Desktop 瀏覽器就會發生了，換作是手機瀏覽器只會讓問題變得更嚴重，因此這種狀況下我們應該優化長列表，提升使用者體驗。</p>
<p>virtualized list 就是優化長列表的一種技巧，名字聽起來很深奧，不過它的概念其實非常簡單：</p>
<blockquote>
<h3 id="用陣列儲存所有列表元素的位置，只渲染可視區-viewport-內的列表元素，當可視區滾動時，根據滾動的-offset-大小以及所有列表元素的位置，計算在可視區應該渲染哪些元素。"><a href="#用陣列儲存所有列表元素的位置，只渲染可視區-viewport-內的列表元素，當可視區滾動時，根據滾動的-offset-大小以及所有列表元素的位置，計算在可視區應該渲染哪些元素。" class="headerlink" title="用陣列儲存所有列表元素的位置，只渲染可視區 (viewport)內的列表元素，當可視區滾動時，根據滾動的 offset 大小以及所有列表元素的位置，計算在可視區應該渲染哪些元素。"></a>用陣列儲存所有列表元素的位置，只渲染可視區 (viewport)內的列表元素，當可視區滾動時，根據滾動的 offset 大小以及所有列表元素的位置，計算在可視區應該渲染哪些元素。</h3></blockquote>
<p><img src="https://i.imgur.com/KgPpFmQ.png"></p>
<p>以上圖來說，假設可視區最多只能顯示 6 個 item，那即使我們的列表總共有 1000 個，也只會渲染出現在可視區的 6 個元素，當原本被渲染的 item 移出可視區後，就會被 unmount 掉，避免前面說的同時生成一堆 dom 節點的狀況，也因此有效的解決了上面說的幾個缺點。</p>
<p>如果對如何實作一個 virtualized list 有興趣，可以參考<a target="_blank" rel="noopener" href="https://medium.com/ingeniouslysimple/building-a-virtualized-list-from-scratch-9225e8bec120">這篇文章</a>。</p>
<h2 id="Tree-Shaking"><a href="#Tree-Shaking" class="headerlink" title="Tree Shaking"></a>Tree Shaking</h2><p>開發專案免不了會下載第三方套件來節省自己重複造輪子的成本，然而也許某些狀況我們只會使用一個套件模組之中的特定幾個 function，其他的 function 幾乎都不會用到。不過如果我們為了這幾個 function 而要載入整個模組，就似乎有點得不償失了，這時候 Tree shaking 會是解救我們的技巧。</p>
<h3 id="什麼是-Tree-Shaking"><a href="#什麼是-Tree-Shaking" class="headerlink" title="什麼是 Tree Shaking ?"></a>什麼是 Tree Shaking ?</h3><p>其實這個技巧跟字面上的意思很像，當用力搖一棵樹時可能會把很笨重的果實給搖落，在程式面來說就是把「用不到的程式碼給搖落下來」，上面的例子講到我們可能會為了幾個特定函式而需要載入整個套件，運用 Tree Shaking 之後，可以讓打包工具在打包階段就可以分析哪些 code 或哪些 function 是用不到的，而把它們從最終的 bundle 中剔除，換句話說就是確保最後的 bundle 不會包含無用或多餘的程式碼與資源，減少 bundle size。</p>
<h3 id="如何做到-Tree-Shaking"><a href="#如何做到-Tree-Shaking" class="headerlink" title="如何做到 Tree Shaking ?"></a>如何做到 Tree Shaking ?</h3><p>要做到 Tree Shaking，首先得透過 ES6 import export 的幫忙</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Import all the array utilities!</span></span><br><span class="line"><span class="keyword">import</span> arrayUtils <span class="keyword">from</span> <span class="string">&quot;array-utils&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>假設我們要使用 array-utils 中的某幾個函式，應該避免上面的引入方式（把整個 array-utils 引入進來，再去使用特定的 property），而改為下面這種引入方式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Import only some of the utilities!</span></span><br><span class="line"><span class="keyword">import</span> &#123; unique, implode, explode &#125; <span class="keyword">from</span> <span class="string">&quot;array-utils&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>不過此時如果用打包工具例如 webpack 打包的話，還是會將整個 array-utils 加進 bundle 裡，此時還得靠例如 <strong>uglifyjs-webpack-plugin</strong> 或其他的 plugin 再加上一些額外設定才能把用不到的程式從 bundle 中移除</p>
<h2 id="Preload、Prefetch-And-Others-In-Link-Tag"><a href="#Preload、Prefetch-And-Others-In-Link-Tag" class="headerlink" title="Preload、Prefetch And Others In Link Tag"></a>Preload、Prefetch And Others In Link Tag</h2><p>這邊要介紹五個特殊的 link 技巧：prefetch、preload、preconnect、dns-preconnect、prerender。讀者可能看起來一頭霧水，不過其實它們都有一個共同的目標，或者說共同的效能優化方式：</p>
<blockquote>
<h3 id="對不久的將來會用到的資源預先處理，這裡的處理有可能是載入資源，或是建立連線，因此在真的要使用到該資源時可以省去不少時間。"><a href="#對不久的將來會用到的資源預先處理，這裡的處理有可能是載入資源，或是建立連線，因此在真的要使用到該資源時可以省去不少時間。" class="headerlink" title="對不久的將來會用到的資源預先處理，這裡的處理有可能是載入資源，或是建立連線，因此在真的要使用到該資源時可以省去不少時間。"></a>對不久的將來會用到的資源預先處理，這裡的處理有可能是載入資源，或是建立連線，因此在真的要使用到該資源時可以省去不少時間。</h3></blockquote>
<h3 id="Preload-VS-Prefetch"><a href="#Preload-VS-Prefetch" class="headerlink" title="Preload VS Prefetch"></a>Preload VS Prefetch</h3><p>preload 與 prefetch 是兩個較常被搞混的技巧，兩者的作用都是在提早取得將來會用到的資源，然而兩者的差別在於：</p>
<ul>
<li>Preload：取得當前頁面的資源（例如字體 font）。</li>
<li>Prefetch：告訴瀏覽器「這些資源我待會會用到，先幫我下載吧！」不過與 preload 不同的是 prefetch 抓取的資源不限於當前頁面使用，也就是可以跨越 navigation，例如你很確定使用者會點擊下一頁，就可以使用 prefetch 預先抓取下一頁的資源。</li>
</ul>
<p>瀏覽器對於資源的載入順序是有規則的，是以檔案類型來決定下載的優先順序，以 chrome 舉例來說（不確定不同瀏覽器是否不同）：</p>
<ul>
<li>High priority : style /font / XHR (sync) </li>
<li>Medium priority : 位於可視區域的圖片 / Preload without as/ XHR (async) </li>
<li>Low priority : favicon、script async / defer / block、不在可視區域的圖片、媒體檔、SVG 等</li>
</ul>
<h3 id="Preconnect"><a href="#Preconnect" class="headerlink" title="Preconnect"></a>Preconnect</h3><p>preconnect 相當於告訴瀏覽器：「這個網頁將會在不久的將來下載某個 domain 的資源，請先幫我建立好連線。」</p>
<p>要理解 preconnect 能夠達成的事，得了解瀏覽器在實際傳輸資源前，實際上經過哪些步驟（以下內容與圖片參考<a target="_blank" rel="noopener" href="https://www.igvita.com/2015/08/17/eliminating-roundtrips-with-preconnect/">這篇文章</a>）：</p>
<ul>
<li>向 DNS 請求解析網域名</li>
<li>TCP Handshake</li>
<li>(HTTPS connection) SSL Negotiation</li>
<li>建立連線完成，等待拿到資料的第一個byte</li>
</ul>
<p>上面的四個步驟中，每一步都會需要一個 RTT (Round Trip Time) 的來回時間。所以在實際傳輸資料之前，已經花了3個 RTT 的時間。如果在網路狀況很差的狀況下，會讓獲取資源的速度大大降低。</p>
<p>利用 preconnect 提早建立好與特定 domain 之間的連線，省去了一次完整的 (DNS Lookup + TCP Handshake + SSL Negotiation) ，共三個 Round Trip Time 的時間。</p>
<h3 id="Preconnect-Use-Cases"><a href="#Preconnect-Use-Cases" class="headerlink" title="Preconnect Use Cases :"></a>Preconnect Use Cases :</h3><p>通常只會對確定短時間內就會用到的 domain 做 preconnect，因為如果 10 秒內沒有使用的話瀏覽器會自動把連線 close 掉</p>
<ul>
<li>CDN：如果網站中有很多資源要從 CDN 拿取，可以 preconnect CDN 的域名，這在不能預先知道有哪些資源要抓取的情況，是蠻適合的 use case。</li>
<li>Streaming 串流媒體 （待會看下方 lite-youtube-embed 的例子）</li>
</ul>
<h3 id="DNS-Preconnect"><a href="#DNS-Preconnect" class="headerlink" title="DNS Preconnect"></a>DNS Preconnect</h3><p>跟 preconnect 類似，差別在於只提示瀏覽器預先處理第一步 DNS lookup 而已。至於什麼時機要使用哪個方式，可以參考這篇 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/47273743/preconnect-vs-dns-prefetch-resource-hints">stackoverflow 問題</a></p>
<h3 id="Prerender"><a href="#Prerender" class="headerlink" title="Prerender"></a>Prerender</h3><p>prerender 比 prefetch 更進一步。不僅僅會下載對應的資源，還會對資源進行解析。解析過程中，如果需要其他的資源，可能會直接下載這些資源，基本上就是盡可能預先渲染下個頁面，這樣一來當用戶在從當前頁面跳轉到目標頁面時，瀏覽器可以快速的響應。適合用在用戶很高機率會轉到另一個頁面的狀況下使用</p>
<h2 id="CDN-amp-Cache"><a href="#CDN-amp-Cache" class="headerlink" title="CDN &amp; Cache"></a>CDN &amp; Cache</h2><p>CDN 的全名為：「Content Delivery Network 內容傳遞網路」。</p>
<p>要知道距離不僅僅是愛情的毒藥（誤），也是影響 response time 的重大因素。假設你身在台灣，跟一個架設在台灣的 server 取資料，花費的時間只要 500 ms，但如果去跟一個架設在美國的 server 取相同的資料，這時候的 response time 可能就增長為 3000 ms。</p>
<p>CDN 就是透過在各個地理位置建立 edge server 來避免取資源時都要跟距離遙遠的 server 溝通，造成效能的低落。當使用者對被 CDN 加速過的域名發出 request 時，CDN 會自動將 request 導到地理位置離使用者較近或是流量較不吃緊的 edge server，儘管第一次取資源時因為 CDN 還沒有快取的資料，所以仍然需要跟 original server 要資料，不過之後的 request 就可以透過地理位置離使用者較近的 CDN cache 取得，加快 client 端資源載入的速度。除了 cahce 機制以外，CDN 某方面也算是增強了服務的可用性、負載功能、安全性（降低 DDOS 對網站的影響）。</p>
<p>如果要更深入了解 CDN 或者 networking cache，推薦參考<a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10225276">這篇鐵人賽的優質文章</a>。</p>
<p>而目前最熱門的免費 CDN 服務大概就是 <strong>Cloudflare</strong> 了， 它主要提供的服務有：</p>
<ul>
<li>CDN</li>
<li>Cache</li>
<li>Load Balancing</li>
<li>代管 DNS</li>
<li>阻擋惡意流量</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://medium.com/starbugs/%E4%BB%8A%E6%99%9A-%E6%88%91%E6%83%B3%E4%BE%86%E9%BB%9E-web-%E5%89%8D%E7%AB%AF%E6%95%88%E8%83%BD%E5%84%AA%E5%8C%96%E5%A4%A7%E8%A3%9C%E5%B8%96-e1a5805c1ca2">今晚，我想來點 Web 前端效能優化大補帖</a></p>

                </div>
                <footer class="kratos-entry-footer clearfix">
                    <div class="post-like-donate text-center clearfix">
                        <a class="read-more" href="/2021/05/22/%E4%BB%8A%E6%99%9A%EF%BC%8C%E6%88%91%E6%83%B3%E4%BE%86%E9%BB%9E%20Web%20%E5%89%8D%E7%AB%AF%E6%95%88%E8%83%BD%E5%84%AA%E5%8C%96%E5%A4%A7%E8%A3%9C%E5%B8%96/#more" title="今晚，我想來點 Web 前端效能優化大補帖">繼續閱讀 <i class="fa fa-chevron-circle-right"></i></a>
                    </div>
                </footer>
            </div>
        </article>
    



    <div class='text-center pagination'>
    <a class="extend prev" rel="prev" href="/tags/%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/tags/%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97/">1</a><span class="page-number current">2</span>
    </div>



    <div class="hidden">
        <!-- 加载文章阅读对应的统计功能，评论自带的那种 -->
        
    </div>



        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
        <div class="sticky-area">
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/avatar.webp" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center"></p>
    </div>
</aside>
            
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>分類目錄</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/123/">123</a><span class="category-list-count">1</span></li></ul></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>標籤</h4>
      <div class="tag-clouds">
        <a href="/tags/Coding-Tips/" style="font-size: 0.7em;">Coding Tips</a> <a href="/tags/OOP/" style="font-size: 0.6em;">OOP</a> <a href="/tags/Operating-System/" style="font-size: 0.6em;">Operating System</a> <a href="/tags/PHP/" style="font-size: 0.6em;">PHP</a> <a href="/tags/Regex/" style="font-size: 0.7em;">Regex</a> <a href="/tags/System-Design/" style="font-size: 0.6em;">System Design</a> <a href="/tags/coding-Tips/" style="font-size: 0.6em;">coding Tips</a> <a href="/tags/front-end/" style="font-size: 0.65em;">front-end</a> <a href="/tags/%E5%8F%AF%E4%B8%8D%E5%8F%AF%E4%BB%A5%E4%B8%8D%E8%A6%81%E5%AF%AB%E7%B3%99-code/" style="font-size: 0.65em;">可不可以不要寫糙 code</a> <a href="/tags/%E5%BD%93%E7%84%B6%E6%88%91%E5%9C%A8%E6%89%AF%E6%B7%A1/" style="font-size: 0.75em;">当然我在扯淡</a> <a href="/tags/%E5%BF%85%E5%8B%9D-IT-%E5%8D%81%E5%85%AB%E6%8B%9B/" style="font-size: 0.6em;">必勝 IT 十八招</a> <a href="/tags/%E8%AC%9B%E5%BA%A7%E5%8F%83%E8%88%87%E5%BF%83%E5%BE%97/" style="font-size: 0.6em;">講座參與心得</a> <a href="/tags/%E9%96%B1%E8%AE%80%E5%BF%83%E5%BE%97/" style="font-size: 0.8em;">閱讀心得</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/2021/09/03/hello-world/"><i class="fa  fa-book"></i> Hello World</a>
            
          
        
          
          
            <a class="list-group-item" href="/2021/05/22/%E4%BB%80%E9%BA%BC%E6%98%AF%E5%B0%8D%E4%BD%BF%E7%94%A8%E8%80%85%E5%8F%8B%E5%A5%BD/"><i class="fa  fa-book"></i> 什麼是對使用者友好</a>
            
          
        
          
          
            <a class="list-group-item" href="/2021/05/22/%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1%20-%20Introducation/"><i class="fa  fa-book"></i> 作業系統 - Introducation</a>
            
          
        
          
          
            <a class="list-group-item" href="/2021/05/22/%E5%8F%AF%E4%B8%8D%E5%8F%AF%E4%BB%A5%E4%B8%8D%E8%A6%81%E5%AF%AB%E7%B3%99%20code%20%E7%B3%BB%E5%88%97%20%E7%AC%AC%208%20%E7%AF%87%20-%20%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84%E8%A8%BB%E8%A7%A3/"><i class="fa  fa-book"></i> 可不可以不要寫糙 code 系列 第 8 篇 - 不必要的註解</a>
            
          
        
          
          
            <a class="list-group-item" href="/2021/05/22/%E5%8F%AF%E4%B8%8D%E5%8F%AF%E4%BB%A5%E4%B8%8D%E8%A6%81%E5%AF%AB%E7%B3%99%20code%E7%B3%BB%E5%88%97%20-%20%E5%A6%82%E4%BD%95%E5%AF%AB%E9%AB%98%E5%93%81%E8%B3%AA%20function/"><i class="fa  fa-book"></i> 可不可以不要寫糙 code系列 - 如何寫高品質 function </a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  >
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        <li><a href="mailto:nagicheng@gmail.com"><i class="fa fa-envelope"></i></a></li>
                        
                        
                        <li><a target="_blank" rel="nofollow" href="https://www.facebook.com/https://www.facebook.com/profile.php?id=100004983279906"><i class="fa fa-facebook-official"></i></a></li>
                        <li><a target="_blank" rel="nofollow" href="https://cn.linkedin.com/in/https://www.linkedin.com/in/nagikon/"><i class="fa fa-linkedin-square"></i></a></li>
                        
                        <li><a target="_blank" rel="nofollow" href="https://github.com/https://github.com/NagiKon"><i class="fa fa-github"></i></a></li>
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2021 Treeboのブログ 版權所有.</li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by Treebo.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="https://github.io" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>





    <script defer src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script>
<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>


    <script defer src="/js/kr-dark.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>